# YAP Contract Deployment Guide

## Overview

This guide walks you through deploying all YAP smart contracts using the company treasury wallet that will also power the blockchain progress reporting system.

## üîß Key Relationships

### `YAP_TREASURY_PRIVATE_KEY` (EVM Private Key)
- **Purpose**: Signs blockchain transactions and pays gas fees
- **Usage**: 
  - Deploy all smart contracts 
  - Submit batched lesson progress transactions
  - Pay gas fees for all blockchain operations
- **Source**: Generated by `generate-company-wallet.js`

### `BATCH_SIGNING_KEY` (Application Key)  
- **Purpose**: Signs batch metadata for verification and audit trails
- **Usage**: Application-level message signing (not blockchain transactions)
- **Source**: Generated during contract deployment
- **Security**: Used for HMAC-style signing of batch operations

## üìã Prerequisites

### 1. Generate Company Wallet
```bash
cd YAP-backend/services/blockchain-progress-service
node generate-company-wallet.js
```
- ‚úÖ Save the 12-word mnemonic securely offline
- ‚úÖ Copy the EVM private key for deployment
- ‚úÖ Note the EVM address for funding

### 2. Fund Company Wallet
The company wallet needs SEI tokens to pay for gas fees:
- Send SEI tokens to the EVM address from wallet generation
- Recommended: Start with 10-20 SEI for contract deployment
- Production: Maintain balance for ongoing batch transactions

### 3. Compile Contracts
```bash
cd YAP-backend/evm_contracts
npm install
npx hardhat compile
```

**‚úÖ Status**: Compilation successful! All essential contract artifacts generated:
- `YapToken.json` - ERC-20 token contract
- `VestingBucket.json` - Vesting logic contract  
- `DailyCompletion.json` - Leaderboard/progress contract

‚ö†Ô∏è **Note**: You may see a case sensitivity warning about `YAPToken` vs `YapToken` - this is safe to ignore.

## ‚úÖ Compilation Status

**Smart contract compilation is now working successfully!**

### Fixed Issues:
- ‚úÖ OpenZeppelin v5 compatibility (`Pausable.sol` and `ReentrancyGuard.sol` import paths)
- ‚úÖ Updated `_beforeTokenTransfer` to `_update` hook for ERC20 v5 compatibility
- ‚úÖ Fixed `supportsInterface` multiple inheritance conflicts
- ‚úÖ Resolved documentation parameter naming issues
- ‚úÖ All core contract artifacts generated successfully

### Available Contracts:
- **YapToken** - ERC-20 token with minting, burning, and vesting integration
- **VestingBucket** - Time-based token vesting with spending controls
- **DailyCompletion** - Lesson progress tracking and reward distribution
- **Additional contracts** - BurnRedeemer, governance, oracle, spending management

## üéâ **DEPLOYMENT SUCCESSFUL!**

### **üì¶ Deployed Contract Addresses (SEI EVM Testnet):**
- **YAP Token**: `0xeEF6Ca01b6EA4217B85cF3347F06d0C13947beaF`
- **Vesting Bucket**: `0x0594eF2bFbaB7fbcd14A55C05a7D99556d221519`
- **Daily Completion** (Leaderboard): `0x05d86f661027c68b775891f723Ba5181719109a1`
- **Deployer Address**: `0x449E8eC2AfD0486a56a77C09E2885d52ef0c3F21`

### **üîê Configured Roles:**
- ‚úÖ Company wallet has admin roles on all contracts
- ‚úÖ DailyCompletion contract can mint YAP tokens for rewards
- ‚úÖ VestingBucket connected to YAP Token for vesting functionality
- ‚úÖ Backend service role granted for transaction submission

**Ready for blockchain progress reporting!** üöÄ

## üöÄ Deployment Process

### Step 1: Set Environment Variable
```bash
export YAP_TREASURY_PRIVATE_KEY="0x..." # From wallet generation
```

### Step 2: Deploy Contracts
```bash
cd YAP-backend/evm_contracts  
node ../services/blockchain-progress-service/deploy-contracts.js
```

### Step 3: Update Kubernetes Secrets
The deployment script will output base64-encoded values for Kubernetes:

```yaml
# Update infra/k8s/blockchain-progress-service.yaml
data:
  YAP_TREASURY_PRIVATE_KEY: "MHhkNWU2YTcw..."  # From wallet generation
  TOKEN_CONTRACT_ADDRESS: "MHg4NzZmZDU..."     # From deployment output
  LEADERBOARD_CONTRACT_ADDRESS: "MHhhYmNkZWY..."  # From deployment output  
  BATCH_SIGNING_KEY: "MHgxMjM0NTY..."          # From deployment output
```

Or use kubectl:
```bash
kubectl patch secret blockchain-secrets \
  --patch='{"data":{"TOKEN_CONTRACT_ADDRESS":"...","LEADERBOARD_CONTRACT_ADDRESS":"...","BATCH_SIGNING_KEY":"..."}}' \
  --namespace=yap-backend
```

## üì¶ Deployed Contracts

### 1. YAPToken (ERC-20)
- **Purpose**: Main YAP token for rewards
- **Features**: Minting, burning, pausable, role-based access
- **Roles**: Company wallet has admin role, can grant minter role

### 2. VestingBucket  
- **Purpose**: Time-based token vesting for user rewards
- **Features**: Gradual token release, vesting schedules
- **Integration**: Connected to YAPToken for transfer locks

### 3. DailyCompletion (Leaderboard)
- **Purpose**: Records lesson progress and calculates rewards
- **Features**: Daily completion tracking, point-to-token conversion
- **Integration**: Uses YAPToken for rewards, VestingBucket for vesting

## üîê Security & Roles

### Contract Roles Setup
The deployment script automatically configures:

1. **YAPToken Roles**:
   - `DEFAULT_ADMIN_ROLE`: Company wallet (can grant other roles)
   - `MINTER_ROLE`: DailyCompletion contract (can mint rewards)
   - `BURNER_ROLE`: Company wallet
   - `PAUSER_ROLE`: Company wallet

2. **DailyCompletion Roles**:
   - `DEFAULT_ADMIN_ROLE`: Company wallet
   - `BACKEND_ROLE`: Company wallet (will be used by blockchain-progress-service)
   - `PAUSER_ROLE`: Company wallet

### Key Management
- **Company Private Key**: Only exists in Kubernetes secrets and memory
- **Batch Signing Key**: Generated fresh for each deployment
- **Role Transfers**: Admin roles remain with company wallet

## üîÑ Integration with Blockchain Progress Service

### Transaction Flow
1. **User completes lesson** ‚Üí Learning service validates
2. **User signs progress** ‚Üí Off-chain EIP712 signature  
3. **Backend batches progress** ‚Üí Collects multiple user signatures
4. **Company signs batch** ‚Üí Uses `YAP_TREASURY_PRIVATE_KEY`
5. **Submit to blockchain** ‚Üí DailyCompletion contract processes batch
6. **Rewards distributed** ‚Üí YAP tokens minted to VestingBucket

### Gas Fee Management
- Company wallet pays all gas fees
- Batch processing reduces per-user gas costs
- Monitor wallet balance for sustainable operations

## üìä Post-Deployment Verification

### 1. Contract Verification
```bash
# Check contract deployments
npx hardhat verify --network sei-testnet <CONTRACT_ADDRESS>
```

### 2. Role Verification
```bash
# Verify roles are set correctly
npx hardhat run scripts/verify-roles.js --network sei-testnet
```

### 3. Integration Test
```bash
# Test blockchain-progress-service integration
kubectl logs -f deployment/blockchain-progress-service -n yap-backend
```

## üîí Security Checklist

- [ ] Company mnemonic stored securely offline
- [ ] Private key only in Kubernetes secrets
- [ ] Contract roles configured correctly  
- [ ] Batch signing key generated uniquely
- [ ] Gas fee wallet monitoring in place
- [ ] Contract addresses verified on blockchain explorer
- [ ] Integration tests passing

## üÜò Troubleshooting

### Common Issues

**"Insufficient funds for gas"**
- Solution: Fund company wallet with more SEI tokens

**"Contract artifact not found"**  
- Solution: Run `npx hardhat compile` in evm_contracts directory

**"Role already granted" errors**
- Solution: Safe to ignore, roles may already be set

**"Nonce too low" errors**
- Solution: Wait for previous transactions to confirm

### Recovery Procedures

**Lost Private Key**
- Use `derive-private-key.js` with stored mnemonic
- Update Kubernetes secrets with recovered key

**Contract Upgrade Needed**
- Deploy new contract versions
- Update Kubernetes configuration  
- Coordinate with frontend for new addresses

The deployment system is now ready to deploy all YAP contracts using the same company wallet that will power the blockchain progress reporting system.
